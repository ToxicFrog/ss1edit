-- CP437 codepoint to UTF8 string mapping
local cp437_table = {
  ["\x80"] = "Ç"; ["\x81"] = "ü"; ["\x82"] = "é"; ["\x83"] = "â";
  ["\x84"] = "ä"; ["\x85"] = "à"; ["\x86"] = "å"; ["\x87"] = "ç";
  ["\x88"] = "ê"; ["\x89"] = "ë"; ["\x8A"] = "è"; ["\x8B"] = "ï";
  ["\x8C"] = "î"; ["\x8D"] = "ì"; ["\x8E"] = "Ä"; ["\x8F"] = "Å";
  ["\x90"] = "É"; ["\x91"] = "æ"; ["\x92"] = "Æ"; ["\x93"] = "ô";
  ["\x94"] = "ö"; ["\x95"] = "ò"; ["\x96"] = "û"; ["\x97"] = "ù";
  ["\x98"] = "ÿ"; ["\x99"] = "Ö"; ["\x9A"] = "Ü"; ["\x9B"] = "¢";
  ["\x9C"] = "£"; ["\x9D"] = "¥"; ["\x9E"] = "₧"; ["\x9F"] = "ƒ";
  ["\xA0"] = "á"; ["\xA1"] = "í"; ["\xA2"] = "ó"; ["\xA3"] = "ú";
  ["\xA4"] = "ñ"; ["\xA5"] = "Ñ"; ["\xA6"] = "ª"; ["\xA7"] = "º";
  ["\xA8"] = "¿"; ["\xA9"] = "⌐"; ["\xAA"] = "¬"; ["\xAB"] = "½";
  ["\xAC"] = "¼"; ["\xAD"] = "¡"; ["\xAE"] = "«"; ["\xAF"] = "»";
  ["\xB0"] = "░"; ["\xB1"] = "▒"; ["\xB2"] = "▓"; ["\xB3"] = "│";
  ["\xB4"] = "┤"; ["\xB5"] = "╡"; ["\xB6"] = "╢"; ["\xB7"] = "╖";
  ["\xB8"] = "╕"; ["\xB9"] = "╣"; ["\xBA"] = "║"; ["\xBB"] = "╗";
  ["\xBC"] = "╝"; ["\xBD"] = "╜"; ["\xBE"] = "╛"; ["\xBF"] = "┐";
  ["\xC0"] = "└"; ["\xC1"] = "┴"; ["\xC2"] = "┬"; ["\xC3"] = "├";
  ["\xC4"] = "─"; ["\xC5"] = "┼"; ["\xC6"] = "╞"; ["\xC7"] = "╟";
  ["\xC8"] = "╚"; ["\xC9"] = "╔"; ["\xCA"] = "╩"; ["\xCB"] = "╦";
  ["\xCC"] = "╠"; ["\xCD"] = "═"; ["\xCE"] = "╬"; ["\xCF"] = "╧";
  ["\xD0"] = "╨"; ["\xD1"] = "╤"; ["\xD2"] = "╥"; ["\xD3"] = "╙";
  ["\xD4"] = "╘"; ["\xD5"] = "╒"; ["\xD6"] = "╓"; ["\xD7"] = "╫";
  ["\xD8"] = "╪"; ["\xD9"] = "┘"; ["\xDA"] = "┌"; ["\xDB"] = "█";
  ["\xDC"] = "▄"; ["\xDD"] = "▌"; ["\xDE"] = "▐"; ["\xDF"] = "▀";
  ["\xE0"] = "α"; ["\xE1"] = "ß"; ["\xE2"] = "Γ"; ["\xE3"] = "π";
  ["\xE4"] = "Σ"; ["\xE5"] = "σ"; ["\xE6"] = "µ"; ["\xE7"] = "τ";
  ["\xE8"] = "Φ"; ["\xE9"] = "Θ"; ["\xEA"] = "Ω"; ["\xEB"] = "δ";
  ["\xEC"] = "∞"; ["\xED"] = "φ"; ["\xEE"] = "ε"; ["\xEF"] = "∩";
  ["\xF0"] = "≡"; ["\xF1"] = "±"; ["\xF2"] = "≥"; ["\xF3"] = "≤";
  ["\xF4"] = "⌠"; ["\xF5"] = "⌡"; ["\xF6"] = "÷"; ["\xF7"] = "≈";
  ["\xF8"] = "°"; ["\xF9"] = "∙"; ["\xFA"] = "·"; ["\xFB"] = "√";
  ["\xFC"] = "ⁿ"; ["\xFD"] = "²"; ["\xFE"] = "■"; ["\xFF"] = " ";
}

local function CP437toUTF8(s)
  return (s:gsub('[\x80-\xFF]', cp437_table))
end

local function UTF8toCP437(s)
  -- HACK HACK HACK
  -- this is appallingly slow
  for codepoint,char in pairs(cp437_table) do
    s = s:gsub(char, codepoint)
  end
  return s
end

return {
  CP437toUTF8 = CP437toUTF8;
  UTF8toCP437 = UTF8toCP437;
}
